{# Cisco NX-OS Configuration Template #}
!
! Generated by NetConfigPro
! Vendor: Cisco NX-OS
!
hostname {{ hostname }}
!
{% if domain_name %}
ip domain-name {{ domain_name }}
{% endif %}
!
{% if dns_servers %}
{% for dns in dns_servers %}
ip name-server {{ dns }}
{% endfor %}
{% endif %}
!
{% if ntp_servers %}
{% for ntp in ntp_servers %}
ntp server {{ ntp }}
{% endfor %}
{% endif %}
!
{% if banner_motd %}
banner motd @
{{ banner_motd }}
@
{% endif %}
!
{# Feature enablement for NX-OS #}
{% if ospf %}
feature ospf
{% endif %}
{% if bgp %}
feature bgp
{% endif %}
{% if interfaces|selectattr('is_trunk')|list or interfaces|selectattr('vlan_id')|list %}
feature interface-vlan
{% endif %}
{% if interfaces|selectattr('channel_group')|list %}
feature lacp
{% endif %}
!
{# VLANs #}
{% if vlans %}
{% for vlan in vlans %}
vlan {{ vlan.vlan_id }}
  name {{ vlan.name }}
{% if vlan.state != 'active' %}
  state {{ vlan.state }}
{% endif %}
!
{% endfor %}
{% endif %}
!
{# Interfaces #}
{% for iface in interfaces %}
interface {{ iface.name }}
{% if iface.description %}
  description {{ iface.description }}
{% endif %}
{% if not iface.enabled %}
  shutdown
{% else %}
  no shutdown
{% endif %}
{% if iface.ip_address and iface.subnet_mask %}
  ip address {{ iface.ip_address }}/{{ iface.subnet_mask | cidr_prefix }}
{% endif %}
{% if iface.is_trunk %}
  switchport mode trunk
{% if iface.native_vlan %}
  switchport trunk native vlan {{ iface.native_vlan }}
{% endif %}
{% if iface.trunk_allowed_vlans %}
  switchport trunk allowed vlan {{ iface.trunk_allowed_vlans }}
{% endif %}
{% elif iface.vlan_id %}
  switchport mode access
  switchport access vlan {{ iface.vlan_id }}
{% endif %}
{% if iface.mtu != 1500 %}
  mtu {{ iface.mtu }}
{% endif %}
{% if iface.channel_group %}
  channel-group {{ iface.channel_group }} mode active
{% endif %}
!
{% endfor %}
!
{# ACLs #}
{% for acl in acls %}
ip access-list {{ acl.name }}
{% for entry in acl.entries %}
{% if entry.remark %}
  {{ entry.sequence }} remark {{ entry.remark }}
{% else %}
  {{ entry.sequence }} {{ entry.action.value }} {{ entry.protocol.value }} {{ entry.source }}{% if entry.source_wildcard != '0.0.0.0' %}/{{ entry.source_wildcard | cidr_prefix }}{% endif %}{% if entry.source_port %} eq {{ entry.source_port }}{% endif %} {{ entry.destination }}{% if entry.destination_wildcard != '0.0.0.0' %}/{{ entry.destination_wildcard | cidr_prefix }}{% endif %}{% if entry.destination_port %} eq {{ entry.destination_port }}{% endif %}{% if entry.log %} log{% endif %}

{% endif %}
{% endfor %}
!
{% endfor %}
!
{# Static Routes #}
{% for route in static_routes %}
ip route {{ route.destination }}/{{ route.mask | cidr_prefix }} {{ route.next_hop }}{% if route.admin_distance != 1 %} {{ route.admin_distance }}{% endif %}{% if route.name %} name {{ route.name }}{% endif %}

{% endfor %}
!
{# OSPF #}
{% if ospf %}
router ospf {{ ospf.process_id }}
{% if ospf.router_id %}
  router-id {{ ospf.router_id }}
{% endif %}
{% if ospf.reference_bandwidth != 100 %}
  auto-cost reference-bandwidth {{ ospf.reference_bandwidth }} Mbps
{% endif %}
!
{% for network in ospf.networks %}
interface {{ network.network }}
  ip router ospf {{ ospf.process_id }} area {{ network.area }}
{% endfor %}
{% endif %}
!
{# BGP #}
{% if bgp %}
router bgp {{ bgp.local_as }}
{% if bgp.router_id %}
  router-id {{ bgp.router_id }}
{% endif %}
{% if bgp.log_neighbor_changes %}
  log-neighbor-changes
{% endif %}
  address-family ipv4 unicast
{% for network in bgp.networks %}
    network {{ network }}
{% endfor %}
{% for neighbor in bgp.neighbors %}
  neighbor {{ neighbor.ip_address }}
    remote-as {{ neighbor.remote_as }}
{% if neighbor.description %}
    description {{ neighbor.description }}
{% endif %}
{% if neighbor.password %}
    password {{ neighbor.password }}
{% endif %}
{% if neighbor.update_source %}
    update-source {{ neighbor.update_source }}
{% endif %}
{% if neighbor.ebgp_multihop > 0 %}
    ebgp-multihop {{ neighbor.ebgp_multihop }}
{% endif %}
    address-family ipv4 unicast
{% if neighbor.route_map_in %}
      route-map {{ neighbor.route_map_in }} in
{% endif %}
{% if neighbor.route_map_out %}
      route-map {{ neighbor.route_map_out }} out
{% endif %}
{% endfor %}
!
{% endif %}
!
end
