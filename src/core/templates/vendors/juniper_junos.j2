{# Juniper Junos Configuration Template #}
## Generated by NetConfigPro
## Vendor: Juniper Junos

system {
    host-name {{ hostname }};
{% if domain_name %}
    domain-name {{ domain_name }};
{% endif %}
{% if dns_servers %}
    name-server {
{% for dns in dns_servers %}
        {{ dns }};
{% endfor %}
    }
{% endif %}
{% if ntp_servers %}
    ntp {
{% for ntp in ntp_servers %}
        server {{ ntp }};
{% endfor %}
    }
{% endif %}
{% if enable_secret %}
    root-authentication {
        encrypted-password "{{ enable_secret }}";
    }
{% endif %}
{% if banner_motd %}
    login {
        message "{{ banner_motd }}";
    }
{% endif %}
}

{% if vlans %}
vlans {
{% for vlan in vlans %}
    {{ vlan.name }} {
        vlan-id {{ vlan.vlan_id }};
{% if vlan.description %}
        description "{{ vlan.description }}";
{% endif %}
    }
{% endfor %}
}
{% endif %}

interfaces {
{% for iface in interfaces %}
    {{ iface.name | junos_interface_name }} {
{% if iface.description %}
        description "{{ iface.description }}";
{% endif %}
{% if not iface.enabled %}
        disable;
{% endif %}
{% if iface.mtu != 1500 %}
        mtu {{ iface.mtu }};
{% endif %}
{% if iface.channel_group %}
        ether-options {
            802.3ad ae{{ iface.channel_group }};
        }
{% endif %}
{% if iface.is_trunk %}
        unit 0 {
            family ethernet-switching {
                port-mode trunk;
{% if iface.trunk_allowed_vlans %}
                vlan {
                    members [ {{ iface.trunk_allowed_vlans }} ];
                }
{% endif %}
{% if iface.native_vlan %}
                native-vlan-id {{ iface.native_vlan }};
{% endif %}
            }
        }
{% elif iface.vlan_id %}
        unit 0 {
            family ethernet-switching {
                port-mode access;
                vlan {
                    members vlan{{ iface.vlan_id }};
                }
            }
        }
{% elif iface.ip_address and iface.subnet_mask %}
        unit 0 {
            family inet {
                address {{ iface.ip_address }}/{{ iface.subnet_mask | cidr_prefix }};
            }
        }
{% endif %}
    }
{% endfor %}
}

routing-options {
{% if static_routes %}
    static {
{% for route in static_routes %}
        route {{ route.destination }}/{{ route.mask | cidr_prefix }} {
            next-hop {{ route.next_hop }};
{% if route.admin_distance != 1 %}
            preference {{ route.admin_distance }};
{% endif %}
{% if route.permanent %}
            retain;
{% endif %}
        }
{% endfor %}
    }
{% endif %}
{% if bgp and bgp.local_as %}
    autonomous-system {{ bgp.local_as }};
{% endif %}
{% if ospf and ospf.router_id %}
    router-id {{ ospf.router_id }};
{% elif bgp and bgp.router_id %}
    router-id {{ bgp.router_id }};
{% endif %}
}

{% if ospf %}
protocols {
    ospf {
{% if ospf.reference_bandwidth != 100 %}
        reference-bandwidth {{ ospf.reference_bandwidth }}m;
{% endif %}
{# Group interfaces by area for proper Junos syntax #}
{% set areas_seen = [] %}
{% for network in ospf.networks %}
{% set area_dotted = '0.0.0.' ~ network.area if network.area < 256 else network.area %}
{% if area_dotted not in areas_seen %}
{% set _ = areas_seen.append(area_dotted) %}
        area {{ area_dotted }} {
{% for net in ospf.networks if ('0.0.0.' ~ net.area if net.area < 256 else net.area) == area_dotted %}
            interface {{ net.network | junos_interface_name }}.0 {
{% if net.network in ospf.passive_interfaces %}
                passive;
{% endif %}
            }
{% endfor %}
        }
{% endif %}
{% endfor %}
    }
}
{% endif %}

{% if bgp %}
protocols {
    bgp {
{% if bgp.log_neighbor_changes %}
        log-updown;
{% endif %}
{% for neighbor in bgp.neighbors %}
{% set is_ibgp = neighbor.remote_as == bgp.local_as %}
        group {{ neighbor.description | default('peer', true) | replace(' ', '_') | replace('-', '_') }} {
            type {{ 'internal' if is_ibgp else 'external' }};
{% if not is_ibgp %}
            peer-as {{ neighbor.remote_as }};
{% endif %}
{% if neighbor.update_source %}
            local-address {{ neighbor.update_source }};
{% endif %}
{% if neighbor.ebgp_multihop > 0 and not is_ibgp %}
            multihop {
                ttl {{ neighbor.ebgp_multihop }};
            }
{% endif %}
            neighbor {{ neighbor.ip_address }} {
{% if neighbor.description %}
                description "{{ neighbor.description }}";
{% endif %}
{% if neighbor.password %}
                authentication-key "{{ neighbor.password }}";
{% endif %}
{% if neighbor.route_map_in %}
                import {{ neighbor.route_map_in }};
{% endif %}
{% if neighbor.route_map_out %}
                export {{ neighbor.route_map_out }};
{% endif %}
            }
        }
{% endfor %}
    }
}
{% endif %}

{% if acls %}
firewall {
{% for acl in acls %}
    family inet {
        filter {{ acl.name }} {
{% for entry in acl.entries %}
{% if entry.remark %}
            /* {{ entry.remark }} */
{% else %}
            term rule-{{ entry.sequence }} {
                from {
{% if entry.protocol.value != 'ip' %}
                    protocol {{ entry.protocol.value }};
{% endif %}
{% if entry.source != 'any' %}
                    source-address {{ entry.source }}/{{ entry.source_wildcard | cidr_prefix }};
{% endif %}
{% if entry.destination != 'any' %}
                    destination-address {{ entry.destination }}/{{ entry.destination_wildcard | cidr_prefix }};
{% endif %}
{% if entry.source_port %}
                    source-port {{ entry.source_port }};
{% endif %}
{% if entry.destination_port %}
                    destination-port {{ entry.destination_port }};
{% endif %}
                }
                then {
{% if entry.action.value == 'permit' %}
                    accept;
{% else %}
                    discard;
{% endif %}
{% if entry.log %}
                    log;
{% endif %}
                }
            }
{% endif %}
{% endfor %}
        }
    }
{% endfor %}
}
{% endif %}
