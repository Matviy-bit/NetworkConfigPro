{# SONiC Configuration Template - config_db.json format #}
{# Generated by NetConfigPro #}
{# Vendor: SONiC (Software for Open Networking in the Cloud) #}
{#
   Build lists for each section type to determine content and comma placement
#}
{% set ns = namespace(sections=[]) %}
{% set _ = ns.sections.append('DEVICE_METADATA') %}

{# Build port list (physical interfaces, not loopback/vlan/portchannel) #}
{% set port_list = [] %}
{% for iface in interfaces %}
{% if iface.interface_type.value not in ['loopback', 'vlan', 'port_channel'] %}
{% set _ = port_list.append(iface) %}
{% endif %}
{% endfor %}
{% if port_list %}{% set _ = ns.sections.append('PORT') %}{% endif %}

{# Build L3 interface list #}
{% set l3_interfaces = [] %}
{% for iface in interfaces %}
{% if iface.ip_address and iface.subnet_mask and iface.interface_type.value not in ['loopback', 'vlan'] %}
{% set _ = l3_interfaces.append(iface) %}
{% endif %}
{% endfor %}
{% if l3_interfaces %}{% set _ = ns.sections.append('INTERFACE') %}{% endif %}

{# Build loopback list #}
{% set loopback_interfaces = [] %}
{% for iface in interfaces %}
{% if iface.interface_type.value == 'loopback' and iface.ip_address %}
{% set _ = loopback_interfaces.append(iface) %}
{% endif %}
{% endfor %}
{% if loopback_interfaces %}{% set _ = ns.sections.append('LOOPBACK_INTERFACE') %}{% endif %}

{# Build portchannel list #}
{% set portchannel_interfaces = [] %}
{% for iface in interfaces %}
{% if iface.interface_type.value == 'port_channel' %}
{% set _ = portchannel_interfaces.append(iface) %}
{% endif %}
{% endfor %}
{% if portchannel_interfaces %}{% set _ = ns.sections.append('PORTCHANNEL') %}{% endif %}

{# Build portchannel with IP list #}
{% set pc_with_ip = [] %}
{% for iface in interfaces %}
{% if iface.interface_type.value == 'port_channel' and iface.ip_address and iface.subnet_mask %}
{% set _ = pc_with_ip.append(iface) %}
{% endif %}
{% endfor %}
{% if pc_with_ip %}{% set _ = ns.sections.append('PORTCHANNEL_INTERFACE') %}{% endif %}

{# Build channel member list #}
{% set channel_members = [] %}
{% for iface in interfaces %}
{% if iface.channel_group %}
{% set _ = channel_members.append(iface) %}
{% endif %}
{% endfor %}
{% if channel_members %}{% set _ = ns.sections.append('PORTCHANNEL_MEMBER') %}{% endif %}

{% if vlans %}{% set _ = ns.sections.append('VLAN') %}{% endif %}

{# Build VLAN member list #}
{% set vlan_members = [] %}
{% for iface in interfaces %}
{% if iface.vlan_id or iface.access_vlan or iface.is_trunk %}
{% set _ = vlan_members.append(iface) %}
{% endif %}
{% endfor %}
{% if vlan_members %}{% set _ = ns.sections.append('VLAN_MEMBER') %}{% endif %}

{# Build VLAN interface list #}
{% set vlan_interfaces = [] %}
{% for iface in interfaces %}
{% if iface.interface_type.value == 'vlan' and iface.ip_address %}
{% set _ = vlan_interfaces.append(iface) %}
{% endif %}
{% endfor %}
{% if vlan_interfaces %}{% set _ = ns.sections.append('VLAN_INTERFACE') %}{% endif %}

{% if static_routes %}{% set _ = ns.sections.append('STATIC_ROUTE') %}{% endif %}
{% if bgp and bgp.neighbors %}{% set _ = ns.sections.append('BGP_NEIGHBOR') %}{% endif %}
{% if acls %}{% set _ = ns.sections.append('ACL_TABLE') %}{% set _ = ns.sections.append('ACL_RULE') %}{% endif %}
{% if ntp_servers %}{% set _ = ns.sections.append('NTP_SERVER') %}{% endif %}
{% if dns_servers %}{% set _ = ns.sections.append('DNS_NAMESERVER') %}{% endif %}
{
    "DEVICE_METADATA": {
        "localhost": {
            "hostname": "{{ hostname }}"{% if bgp and bgp.local_as %},
            "bgp_asn": "{{ bgp.local_as }}"{% endif %},
            "type": "ToRRouter",
            "synchronous_mode": "enable"
        }
    }{% if ns.sections | length > 1 %},{% endif %}

{% if port_list %}
    "PORT": {
{% for iface in port_list %}
        "{{ iface.name | sonic_interface_name }}": {
            "admin_status": "{{ 'up' if iface.enabled else 'down' }}"{% if iface.description %},
            "description": "{{ iface.description }}"{% endif %}{% if iface.mtu != 1500 %},
            "mtu": "{{ iface.mtu }}"{% endif %}{% if iface.speed %},
            "speed": "{{ iface.speed }}"{% endif %}
        }{% if not loop.last %},{% endif %}

{% endfor %}
    }{% if 'PORT' != ns.sections[-1] %},{% endif %}

{% endif %}
{% if l3_interfaces %}
    "INTERFACE": {
{% for iface in l3_interfaces %}
        "{{ iface.name | sonic_interface_name }}|{{ iface.ip_address }}/{{ iface.subnet_mask | cidr_prefix }}": {}{% if not loop.last %},{% endif %}

{% endfor %}
    }{% if 'INTERFACE' != ns.sections[-1] %},{% endif %}

{% endif %}
{% if loopback_interfaces %}
    "LOOPBACK_INTERFACE": {
{% for iface in loopback_interfaces %}
        "{{ iface.name | sonic_interface_name }}|{{ iface.ip_address }}/{{ iface.subnet_mask | cidr_prefix }}": {}{% if not loop.last %},{% endif %}

{% endfor %}
    }{% if 'LOOPBACK_INTERFACE' != ns.sections[-1] %},{% endif %}

{% endif %}
{% if portchannel_interfaces %}
    "PORTCHANNEL": {
{% for iface in portchannel_interfaces %}
        "{{ iface.name | sonic_interface_name }}": {
            "admin_status": "{{ 'up' if iface.enabled else 'down' }}"{% if iface.mtu != 1500 %},
            "mtu": "{{ iface.mtu }}"{% endif %}
        }{% if not loop.last %},{% endif %}

{% endfor %}
    }{% if 'PORTCHANNEL' != ns.sections[-1] %},{% endif %}

{% endif %}
{% if pc_with_ip %}
    "PORTCHANNEL_INTERFACE": {
{% for iface in pc_with_ip %}
        "{{ iface.name | sonic_interface_name }}|{{ iface.ip_address }}/{{ iface.subnet_mask | cidr_prefix }}": {}{% if not loop.last %},{% endif %}

{% endfor %}
    }{% if 'PORTCHANNEL_INTERFACE' != ns.sections[-1] %},{% endif %}

{% endif %}
{% if channel_members %}
    "PORTCHANNEL_MEMBER": {
{% for iface in channel_members %}
        "PortChannel{{ '%04d' | format(iface.channel_group) }}|{{ iface.name | sonic_interface_name }}": {}{% if not loop.last %},{% endif %}

{% endfor %}
    }{% if 'PORTCHANNEL_MEMBER' != ns.sections[-1] %},{% endif %}

{% endif %}
{% if vlans %}
    "VLAN": {
{% for vlan in vlans %}
        "Vlan{{ vlan.vlan_id }}": {
            "vlanid": "{{ vlan.vlan_id }}"
        }{% if not loop.last %},{% endif %}

{% endfor %}
    }{% if 'VLAN' != ns.sections[-1] %},{% endif %}

{% endif %}
{% if vlan_members %}
    "VLAN_MEMBER": {
{% for iface in vlan_members %}
{% if iface.vlan_id or iface.access_vlan %}
        "Vlan{{ iface.vlan_id or iface.access_vlan }}|{{ iface.name | sonic_interface_name }}": {
            "tagging_mode": "untagged"
        }{% if not loop.last %},{% endif %}

{% elif iface.is_trunk and iface.trunk_allowed_vlans %}
{% set trunk_vlans = iface.trunk_allowed_vlans.split(',') %}
{% for vlan_id in trunk_vlans %}
        "Vlan{{ vlan_id | trim }}|{{ iface.name | sonic_interface_name }}": {
            "tagging_mode": "tagged"
        }{% if not loop.last %},{% endif %}

{% endfor %}
{% endif %}
{% endfor %}
    }{% if 'VLAN_MEMBER' != ns.sections[-1] %},{% endif %}

{% endif %}
{% if vlan_interfaces %}
    "VLAN_INTERFACE": {
{% for iface in vlan_interfaces %}
        "Vlan{{ iface.name | sonic_vlan_id }}|{{ iface.ip_address }}/{{ iface.subnet_mask | cidr_prefix }}": {}{% if not loop.last %},{% endif %}

{% endfor %}
    }{% if 'VLAN_INTERFACE' != ns.sections[-1] %},{% endif %}

{% endif %}
{% if static_routes %}
    "STATIC_ROUTE": {
{% for route in static_routes %}
        "{{ route.destination }}/{{ route.mask | cidr_prefix }}": {
            "nexthop": "{{ route.next_hop }}"{% if route.admin_distance != 1 %},
            "distance": "{{ route.admin_distance }}"{% endif %}
        }{% if not loop.last %},{% endif %}

{% endfor %}
    }{% if 'STATIC_ROUTE' != ns.sections[-1] %},{% endif %}

{% endif %}
{% if bgp and bgp.neighbors %}
    "BGP_NEIGHBOR": {
{% for neighbor in bgp.neighbors %}
        "{{ neighbor.ip_address }}": {
            "asn": "{{ neighbor.remote_as }}"{% if neighbor.description %},
            "name": "{{ neighbor.description }}"{% endif %}{% if neighbor.update_source %},
            "local_addr": "{{ neighbor.update_source }}"{% endif %},
            "holdtime": "180",
            "keepalive": "60"
        }{% if not loop.last %},{% endif %}

{% endfor %}
    }{% if 'BGP_NEIGHBOR' != ns.sections[-1] %},{% endif %}

{% endif %}
{% if acls %}
    "ACL_TABLE": {
{% for acl in acls %}
        "{{ acl.name }}": {
            "type": "L3",
            "policy_desc": "{{ acl.name }}"{% if port_list %},
            "stage": "ingress",
            "ports": [
{% for iface in port_list %}
                "{{ iface.name | sonic_interface_name }}"{% if not loop.last %},{% endif %}

{% endfor %}
            ]{% endif %}
        }{% if not loop.last %},{% endif %}

{% endfor %}
    }{% if 'ACL_TABLE' != ns.sections[-1] %},{% endif %}

    "ACL_RULE": {
{% for acl in acls %}
{% for entry in acl.entries %}
{% if not entry.remark %}
        "{{ acl.name }}|RULE_{{ entry.sequence }}": {
            "PRIORITY": "{{ 10000 - entry.sequence }}",
            "PACKET_ACTION": "{{ 'FORWARD' if entry.action.value == 'permit' else 'DROP' }}"{% if entry.protocol.value != 'ip' %},
            "IP_PROTOCOL": "{{ '6' if entry.protocol.value == 'tcp' else '17' if entry.protocol.value == 'udp' else '1' if entry.protocol.value == 'icmp' else '' }}"{% endif %}{% if entry.source != 'any' %},
            "SRC_IP": "{{ entry.source }}/{{ entry.source_wildcard | wildcard_to_cidr }}"{% endif %}{% if entry.destination != 'any' %},
            "DST_IP": "{{ entry.destination }}/{{ entry.destination_wildcard | wildcard_to_cidr }}"{% endif %}{% if entry.source_port %},
            "L4_SRC_PORT": "{{ entry.source_port }}"{% endif %}{% if entry.destination_port %},
            "L4_DST_PORT": "{{ entry.destination_port }}"{% endif %}
        }{% if not loop.last %},{% endif %}

{% endif %}
{% endfor %}
{% if not loop.last %},{% endif %}
{% endfor %}
    }{% if 'ACL_RULE' != ns.sections[-1] %},{% endif %}

{% endif %}
{% if ntp_servers %}
    "NTP_SERVER": {
{% for ntp in ntp_servers %}
        "{{ ntp }}": {}{% if not loop.last %},{% endif %}

{% endfor %}
    }{% if 'NTP_SERVER' != ns.sections[-1] %},{% endif %}

{% endif %}
{% if dns_servers %}
    "DNS_NAMESERVER": {
{% for dns in dns_servers %}
        "{{ dns }}": {}{% if not loop.last %},{% endif %}

{% endfor %}
    }
{% endif %}
}
